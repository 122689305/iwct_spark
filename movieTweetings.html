
<!DOCTYPE html>
<html lang='en'>
    <head>
        <script src="static/js/d3.v3.min.js" charset="utf-8"></script>
        <script src="static/js/jquery.min.js" charset="utf-8"></script>
        <script src="static/js/omdb-movie-info.js" charset="utf-8"></script>
        <meta charset="utf-8">
        <title>Weibo Topics stats</title>

        <!-- Bootstrap -->
        <link href="static/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <script src="static/js/bootstrap.min.js"></script>
    </head>

    <body>

        <div class="container-fluid">
            <div class="row-fluid">

                <div class="span2">
                    <!--Sidebar content
                    <div style='margin-top:155px;' class='well well-small'>The Weibo Topics dataset extracts movie ratings contained in tweets like these below.</div>
                    <a class="twitter-timeline" href="https://twitter.com/search?q=I+rated+%23IMDb" data-widget-id="397715661188653056">Tweets about "I rated #IMDb"</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                    -->
                </div>

                <div class="span8">
                    <!--Body content-->
                    <div class='well'>
                        <h1>Weibo Topics statistics</h1>
                        <p>Some statistics for the <a href='https://github.com/sidooms/Weibo Topics'>Weibo Topics</a> dataset. These stats are refreshed on a daily basis. Graphs are drawn with the <a href='http://d3js.org'>D3.js JavaScript library</a>. Basic layout with <a href='http://getbootstrap.com/'>Twitter Bootstrap framework</a>.</p>
                    </div>      
                    <div class='well'>
                        <h2>Basic numbers</h2>
                        <p class='stats'>Loading...</p>
                    </div>
                    <div class='well'>
                        <h2>Weibo Topics Top 10 (Last Week)</h2>
                        <p>Calculated as a Bayesian estimate like the <a href='http://www.imdb.com/chart/top?ref_=nv_sr_1'>top 250 IMDb movies</a>. Only rating data from the past 7 days (sliding window) is taken into account.</p>
                        <p id='top10listweek'></p>
                    </div>
                    <div class='well'>
                        <h2>Weibo Topics Top 10 (Overall)</h2>
                        <p>Calculated as a Bayesian estimate like the <a href='http://www.imdb.com/chart/top?ref_=nv_sr_1'>top 250 IMDb movies</a>.</p>
                        <p id='top10list'></p>
                    </div>
                    <div class='well' >
                        <h2>Topic popularity</h2>
                        <p id='graph-item-popularity'></p>
                        <p>Every movie is a circle; its radius reflecting the corresponding popularity (number of ratings). Colors are randomly assigned, as is the position of every circle (with some collision detection). Topics with less than 10 ratings are hidden to reduce the complexity. <strong>Mouseover</strong> (hover) a circle to see the movie title, <strong>click</strong> to open the corresponding IMDb page.</p>
                        <p><a href='item-popularity.html'>Go here</a> for a fullscreen visualization (be patient, loading takes some time).</p>
                    </div>
                    <div class='well'>
                        <h2>Number of ratings per day</h2>
                        <p id='graph-ratings-per-day'></p>
                    </div>
                    <div class='well'>
                        <h2>Number of ratings per day (cumulative)</h2>
                        <p id='graph-ratings-per-day-cumulative'></p>
                    </div>
                </div>
                <div class="span2"></div>
            </div>
        </div>

        <style>

            .graph {
                font: 10px sans-serif;
            }

            .stats{

                /*margin-left: 50px;*/
            }

            .base-stat-key{
                margin-right: 10px;
            }
            .base-stat-val{


            }

            .omdb-movie{
                margin:0px;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            .area {
                fill: steelblue;
                stroke:black;
            }

            circle {
                stroke: #000;
                stroke-opacity: .5;
            }

        </style>

        <script>


            function load_basic_stats_file(){
                $.ajax({
                    url: "http://wicaserv5.intec.ugent.be/mt/stats.csv",
                    success: function(csvdata){
                        $(".stats").html('');
                        var lines = csvdata.split(/\n/);
                        var length = lines.length;
                        var keys = "";
                        var vals = "";
                        for (var i = 0; i < length; i++) {
                            line = lines[i];
                            line_arr =  line.split(/,/);
                            key = line_arr[0];
                            val = line_arr[1];
                            if (typeof(val) != 'undefined'){
                                keys += key + ':<br>';
                                vals += '<strong>' + numberWithCommas(val) + '</strong><br>';
                            }
                        }
                        $(".stats").append('<div class="base-stat-key pull-left">'+ keys + ' </div>');
                        $(".stats").append('<div class="base-stat-val">'+ vals + ' </div>');
                    },
                    cache: false
                });
            }

            function numberWithCommas(x){
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            var screen_width = $( window ).width() / 12 * 8;
            var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = (screen_width - (margin.left*2) - (margin.right*2)) ,
            height = 400 - margin.top - margin.bottom;

            var x = d3.time.scale()
            .range([0, width]);

            var y = d3.scale.linear()
            .range([height, 0]);

            var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

            var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

            function keys(obj){
                var keys = [];
                for(var key in obj)
                {
                    if(obj.hasOwnProperty(key))
                    {
                        keys.push(key);
                    }
                }
                return keys;
            }

            var area = d3.svg.area()
            .x(function(d) { return x(d.date); })
            .y0(height)
            .y1(function(d) { return y(d.close); });

            var svg = d3.select("#graph-ratings-per-day").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr('class', 'graph')
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");      

            var svg2 = d3.select("#graph-ratings-per-day-cumulative").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr('class', 'graph')
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");    

            var svg3 = d3.select("#graph-item-popularity").append("svg")
            .attr("width",  width + margin.left + margin.right)
            .attr("height",  height + margin.top + margin.bottom);

            var nodes = [];
            //make sure server has the latest ratings file from github
            $.ajax({
                url: "ratings.php"
                }).done(function ( fdfdfqdf ) {

                d3.text("movies.dat", function(text_movies) {

                    d3.text("ratings.dat", function(text) {
                        load_basic_stats_file();
                        text_movies = text_movies.replace(/::/g, '[');
                        var dsv = d3.dsv("[", "text/plain");  
                        //var dsv = d3.dsv("::", "text/plain");  
                        //load the movie_title index
                        var movierows = dsv.parseRows(text_movies);
                        var dict_movie_title = new Object;
                        //console.log(movierows);
                        movierows.forEach(function(d) {
                            //    console.log(d);
                            //dict_movie_title[d[0]] = d[2];
                            dict_movie_title[d[0]] = d[1];
                        });

                        var dsv = d3.dsv("::", "text/plain");  
                        var rows = dsv.parseRows(text);
                        /*
                        0: "1" user
                        1: ""
                        2: "0015400" item
                        3: ""
                        4: "9" rating
                        5: ""
                        6: "1383756270" time
                        */
                        /*
                        Count number of ratings per day
                        */
                        var counts = new Object;
                        var item_count = new Object();
                        var total_popularity = 0;
                        rows.forEach(function(d) {
                            thedate = (+d[6]) - ((+d[6]) % 86400);
                            if (typeof(counts[thedate]) == 'undefined'){
                                counts[thedate] = 1
                                }else{
                                counts[thedate] += 1;
                            }
                            item = d[2];
                            if (typeof(item_count[item]) == 'undefined'){
                                item_count[item] = 1
                                }else{
                                item_count[item] += 1;
                            }
                            total_popularity += 1;
                        });


                        var data = [];
                        var cumsum = [];
                        var previous = 0;
                        var thekeys = keys(counts).sort(function(a,b){return a-b}); 
                        for (var keyindex in thekeys){
                            key = thekeys[keyindex];
                            row = new Object;
                            cumsumrow = new Object;
                            row.date = new Date(key*1000);
                            cumsumrow.date = new Date(key*1000);
                            row.close = counts[key];
                            cumsumrow.close = counts[key] + previous;
                            previous += counts[key];
                            data.push(row);
                            cumsum.push(cumsumrow);
                        }

                        x.domain(d3.extent(data, function(d) { return d.date; }));
                        y.domain([0, d3.max(data, function(d) { return d.close; })]);

                        svg.append("path")
                        .datum(data)
                        .attr("class", "area")
                        .attr("d", area);

                        svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                        svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Number of ratings (tweets)");

                        svg.append("text")
                        .attr("x", (width / 2))             
                        .attr("y", 0 + ((margin.top / 2)*4))
                        .attr("text-anchor", "middle")  
                        .style("font-size", "20px") 
                        .text("Number of ratings (tweets) per day");


                        x.domain(d3.extent(cumsum, function(d) { return d.date; }));
                        y.domain([0, d3.max(cumsum, function(d) { return d.close; })]);

                        svg2.append("path")
                        .datum(cumsum)
                        .attr("class", "area")
                        .attr("d", area);

                        svg2.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                        svg2.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Number of ratings (tweets)");

                        svg2.append("text")
                        .attr("x", (width / 2))             
                        .attr("y", 0 + ((margin.top / 2)*4))
                        .attr("text-anchor", "middle")  
                        .style("font-size", "20px") 
                        .text("Total number of ratings (tweets)"); 



                        var maxRadius = Math.sqrt((width*height)/Math.PI) * 15;
                        nodes = [];
                        //order from popular (big) items to small ones
                        //popularity => item
                        var popu_items = new Object();
                        for (var item in item_count){
                            popu_items[+(item_count[item] + Math.random())] = item;   
                        }
                        var thekeys = keys(popu_items).sort(function(a,b){return a-b}).reverse(); 
                        for (var thekeyindex in thekeys){
                            var item = popu_items[thekeys[thekeyindex]];
                            circ  = new Object();
                            circ.radius = (+item_count[item] / total_popularity) * maxRadius;
                            circ.x = get_random_x_circle (circ.radius, width, margin.left, margin.right);
                            circ.y = get_random_y_circle (circ.radius, height, margin.top, margin.bottom);
                            circ.id = item;
                            circ.title = dict_movie_title[item];

                            circ = fix_overlapping_nodes(nodes, circ);

                            nodes.push(circ);
                            if (item_count[item] < 10){
                                break;
                            }
                        }


                        var color = d3.scale.category10();


                        svg3.selectAll("circle")
                        .data(nodes)
                        .enter().append("svg:circle")
                        .on("mousedown", mousedown)
                        .attr("r", function(d) { return d.radius ; })
                        .style("fill", function(d, i) { return color(i);        })
                        .style("cursor", "pointer")
                        .append("svg:title")
                        .text(function(d) { return d.title; });


                        svg3.selectAll("circle")
                        .attr("cx", function(d) { return d.x; })
                        .attr("cy", function(d) { return d.y; });

                        function fix_overlapping_nodes(nodes, new_node){
                            var keep_fixing = true;
                            var max_iterations = nodes.length * 2,
                            iterations = 0;
                            while (keep_fixing & iterations < max_iterations){
                                keep_fixing = false;
                                for (var i in nodes){
                                    node = nodes[i];
                                    if (circlesCollide(node, new_node)){
                                        keep_fixing = true;
                                        //new location for node
                                        new_node.x = get_random_x_circle (new_node.radius, width, margin.left, margin.right);
                                        new_node.y = get_random_y_circle (new_node.radius, height, margin.top, margin.bottom);
                                        break;
                                    }
                                }
                                iterations += 1;
                            }
                            return new_node;
                        }

                        function get_random_x_circle(radius, width, marginleft, marginright){
                            return (Math.random()*((width + marginleft + marginright )-radius*2))+radius ;
                        }

                        function get_random_y_circle(radius, height, margintop, marginbottom){
                            return (Math.random()*((height + margintop + marginbottom )-radius*2))+radius ;
                        }



                        //http://stackoverflow.com/questions/4170901/how-to-detect-overlapping-circles-and-fill-color-accordingly
                        function circlesCollide(node_1, node_2){
                        x1 = node_1.x;
                        y1 = node_1.y;
                        r1 = node_1.radius;
                        x2 = node_2.x;
                        y2 = node_2.y;
                        r2 = node_2.radius;        
                        return (distance(x1, y1, x2, y2) <= (r1 + r2 + 2));
                        }
                        function distance(x1, y1, x2, y2) {
                        return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
                        }


                        function mousedown(d){
                        url = "http://www.imdb.com/title/tt" + d.id;
                        var win=window.open(url);
                        win.focus();
                        }


                        }); //d3 text

                        }); //d3 text movies

                        }); //ajax call for ratings.php


                        /*
                        Read the top 10 list
                        */
                        $.ajax({
                        url: "top_10_list.csv",
                        success: function(csvdata){
                        $("#top10list").html('');
                        var lines = csvdata.split(/\n/);
                        var length = lines.length;
                        var the_html = '';
                        for (var i = 0; i < length; i++) {
                        line = lines[i];
                        if (typeof(line) == 'undefined' || line == ''){
                        continue
                        }
                        the_html += '<div class="omdb-movie">';
                            the_html += '<span class="omdb-imdbid" style="display:none">';
                                the_html += line
                                the_html += '</span>';
                            the_html += (i+1) + '. ';
                            the_html += '<a href="http://www.imdb.com/title/' + line + '">';
                                the_html += '<span class="omdb-title">Loading</span>';
                                the_html += '</a>';
                            the_html += ' (<span class="omdb-year">...</span>)';
                            the_html += '</div>';
                        }
                        $("#top10list").html(the_html);
                        load_omdb_data();
                        },
                        cache: false
                        });


                        /*
                        Read the top 10 list week
                        */
                        $.ajax({
                        url: "top_10_last_week_list.csv",
                        success: function(csvdata){
                        $("#top10listweek").html('');
                        var lines = csvdata.split(/\n/);
                        var length = lines.length;
                        var the_html = '';
                        for (var i = 0; i < length; i++) {
                        line = lines[i];
                        if (typeof(line) == 'undefined' || line == ''){
                        continue
                        }
                        the_html += '<div class="omdb-movie">';
                            the_html += '<span class="omdb-imdbid" style="display:none">';
                                the_html += line
                                the_html += '</span>';
                            the_html += (i+1) + '. ';
                            the_html += '<a href="http://www.imdb.com/title/' + line + '">';
                                the_html += '<span class="omdb-title">Loading</span>';
                                the_html += '</a>';
                            the_html += ' (<span class="omdb-year">...</span>)';
                            the_html += '</div>';
                        }
                        $("#top10listweek").html(the_html);
                        load_omdb_data();
                        },
                        cache: false
                        });

                    </script>





                    <script>
                        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                        ga('create', 'UA-44849792-1', 'ugent.be');
                        ga('send', 'pageview');

                    </script>
                </body>
            </html>
